# Kafka使用

# 场景

```
需求：    
项目需要通过kafka消息中间件实现服务之间解耦、异步处理。

实际需求分析：
    1. 消息数据量：审批流程的消息——数据量很小。
    2. 是否顺序消息：是，同一个审批流程的消息必须是按顺序处理。
    3. 是否可以丢失消息：不可以
    4. 是否需要低延时：不需要，慢一点用户无感知。
    5. 消息处理失败是否可以跳过处理：不可以，需要重试N次后，邮件告警人工处理。

kafka发送消息丢失（错误）场景：   
1、发送消息到Broker服务端并回复保存成功。未异步同步到其他副本，leader副本节点宕机，导致消息丢失。       
    ——解决方案：业务场景能接受发送消息高延时且消息数据量小，故在Producer配置ack=all，所有可用副本都收到消息，Broker服务端才会返回消息保存成功。ps：正常情况下延时不会超过1秒。    
2、Broker服务端接收消息后无响应或响应丢失 ——开启在Producer配置retries>0，客户端自动重试。   
3、Producer自动retry发送次数后，收到发送失败的异常 ——需要程序立即回滚，因转人工处理成本太高，待kafka集群恢复正常后，web界面再次触发消息发送（审批）即可。

重复消费场景描述：   
1、消费端正常处理消息成功，但提交位移失败。    
2、Producer发送方retries，导致消息重复。    
3、Producer发送方主动重复发送。
解决方案：   
 第一步，根据消息的id查询消息redis中是否存在，如果存在则该消息已经消费过，则提交位移，消费下一个消息。    
 第二步，消息未被消费过，正常处理消息。    
 第三步，消息处理成功后，将消息的id保存到redis中，有效期15-30天即可。    
 第四步，提交消息消费位移
 
 消息消费失败场景描述：    
 1、其他服务不可用（例如商品服务、ftp服务器）    
 2、消息数据格式不正确，导致消费者端报错。    
 解决方案：        
 使用业务标识（例如商品创建模块+商品id）作为消息的key，保证消息发送到topic的同一个分区中。目的：之前使用单分区保证消息的顺序，出现消息消费失败时会卡住的问题，增加分区降低消费失败卡住的影响范围，    如果设置10个分区则一个分区卡主影响的范围为1/10。   
消费失败，抛出异常结束本次消费，不提交位移（提交当前的消息位移），程序暂停3分钟，再次消费，同时记录消费失败累计次数，累计5次后跳过该消息（本系统场景可以跳过消息，仅影响一个审批流程），同时邮件&短信通知人工处理。

```

